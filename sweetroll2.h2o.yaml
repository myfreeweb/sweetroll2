"/":
  - reproxy: ON
    mruby.handler: |
      lambda do |env|
        if env["PATH_INFO"].end_with?("/") && env["PATH_INFO"] != "/"
          loc = env["PATH_INFO"]
          while loc.end_with?("/") && loc != "/"
            loc = loc.chomp("/")
          end
          if env["QUERY_STRING"].length > 0
            loc += "?#{env["QUERY_STRING"]}"
          end
          return [301, { "location" => loc }, []]
        end
        if (env["HTTP_COOKIE"].nil? || !env["HTTP_COOKIE"].include?("wheeeee=C")) && File.exist?(File.join("out/", env["PATH_INFO"], "index.html"))
          return [307, { "x-reproxy-url" => "/__out__" + env["PATH_INFO"] }, []]
        end
        return [399, {}, []]
      end
  - proxy.preserve-host: ON
    proxy.reverse.url: "http://127.0.0.1:6969/"
"/__as__/":
  - mruby.handler: |
      lambda do |env|
        headers = {}
        if env["QUERY_STRING"].include?("vsn=")
          headers["cache-control"] = "public, max-age=31536000, immutable"
        end
        return [399, headers, []]
      end
  - header.add: "x-content-type-options: nosniff"
    file.dir: priv/static/
"/__out__/":
  - mruby.handler: |
      lambda do |env|
        if env["h2o.remaining_delegations"] == 5
          return [401, {}, ["Where do you think you're going??"]]
        end
        return [399, {
          "link" => "<#{env['rack.url_scheme']}://#{env['SERVER_NAME']}#{env['PATH_INFO']}>; rel=\"self\""
        }, []]
      end
  - header.add: 'link: <https://pubsubhubbub.superfeedr.com/>; rel="hub", </__webmention__>; rel="webmention", </__micropub__>; rel="micropub", </__auth__/authorize>; rel="authorization_endpoint", </__auth__/token>; rel="token_endpoint"'
    header.add: "strict-transport-security: max-age=31536000"
    header.add: "feature-policy: unsized-media 'none'; sync-xhr 'none'; document-write 'none'"
    header.add: "referrer-policy: no-referrer-when-downgrade"
    file.dir: out/
